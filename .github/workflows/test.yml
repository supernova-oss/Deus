# ===--------------------------------------------------------------------------------------------===
# Copyright Â© 2025 Supernova. All rights reserved.
#
# This file is part of the Deus open-source project.
#
# This program is free software: you can redistribute it and/or modify it under the terms of the GNU
# General Public License as published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
# even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with this program. If not,
# see https://www.gnu.org/licenses.
# ===--------------------------------------------------------------------------------------------===

name: Test
on:
  pull_request:
    branches: [ 'main' ]
  push:
    branches: [ 'main' ]
jobs:
  test:
    runs-on: macos-26
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_26.2.app/Contents/Developer
      - name: Test
        run: |
             chmod +x setup.sh
             source setup.sh
             source tooling/dswtc.sh
             mkdir .build
             xcodebuild                                                                               \
               -allowProvisioningUpdates                                                              \
               -destination 'platform=OS X,arch=${{ matrix.arch }}'                                   \
               -resultBundlePath .build/ResultBundle_${{ github.run_id }}_${{ matrix.arch }}.xcresult \
               -scheme Deus                                                                           \
               -toolchain "$(dswtc_id)"                                                               \
               -verbose                                                                               \
               CODE_SIGN_IDENTITY='-'                                                                 \
               build                                                                                  \
               test
      - name: Export result
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ResultBundle_${{ github.run_id }}_${{ matrix.arch }}.xcresult
          path: ResultBundle_${{ github.run_id }}_${{ matrix.arch }}.xcresult
    strategy:
      matrix:
        arch: [x86_64, arm64]

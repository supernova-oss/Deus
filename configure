#!/bin/bash
# ===--------------------------------------------------------------------------------------------===
# Copyright © 2025 Supernova. All rights reserved.
#
# This file is part of the Deus open-source project.
#
# This program is free software: you can redistribute it and/or modify it under the terms of the GNU
# General Public License as published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
# even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with this program. If not,
# see https://www.gnu.org/licenses.
# ===--------------------------------------------------------------------------------------------===

# This script performs the initial configuration of the environment for building and testing Deus
# locally. It is recommended that it be run after the project is cloned and every time the Swift
# toolchain in use is changed, given that the project relies on a specific development snapshot of
# such toolchain.

project_directory="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
option="$(echo "$@" | xargs)"

print_overview() {
  echo "OVERVIEW: Performs the initial configuration of the environment for building and testing \
the project."
}

print_help() {
  cat <<EOF
$(print_overview)

OPTIONS:
  -h, --help
    Provide assistance as to how to utilize this command.

  --sym-link-xcswtc-to-dswtc
    Includes a symbolic link from the Xcode-bundled Swift toolchain to that required by Deus. This \
is essential for continuous integration (CI) because of an issue with SwiftPM, which remains \
unsolved as of December 29, 2025. For more details, see \
https://github.com/supernova-oss/Deus/pull/58#issuecomment-3696928780.
    Given that the project builds successfuly when built from Xcode (as of Xcode 26.2), passing \
this option in outside of CI is discouraged, as other tools depending on the Xcode-bundled Swift \
toolchain may break or work unexpectedly due to incompatibility with the toolchain required by \
Deus. If you do so, remember to execute \`./deconfigure --xcswtc-to-dswtc-symlink-only\` \
afterward, which will remove such symlink.
EOF
}

print_titled_overview() {
  CAT <<EOF
Deus: configure
$(print_overview)
EOF
}

error() {
  case "$option" in
    -*)
      argument_name='option'
      ;;
    *)
      argument_name='argument'
      ;;
  esac
  cat << EOF
Error: unexpected $argument_name '$option'.
Usage: ./configure <option>
  See './configure --help' for more information.
EOF
  exit 1
}

prepare_binaries_for_execution() {
  local binaries_path="$project_directory"/bin
  export PATH="$binaries_path":$PATH
  chmod +x deconfigure
}

configure_swiftly() {
  echo '=== SWIFTLY ==='
  echo 'Checking presence…'
  if [ -f ~/.swiftly/bin/swiftly ] &>/dev/null; then
    was_swiftly_previously_installed=true
    echo 'Already installed. Skipping download and installation.'
  else
    was_swiftly_previously_installed=false
    swiftly_package_path=~/Downloads/swiftly-"$(uuidgen)".pkg
    echo 'Not downloaded. Downloading…'
    curl                                                    \
      --location                                            \
      --output "$swiftly_package_path"                      \
      https://download.swift.org/swiftly/darwin/swiftly.pkg \
      2>/dev/null
    echo 'Downloaded.'
    echo 'Installing…'
    installer -pkg "$swiftly_package_path" -target CurrentUserHomeDirectory 1>/dev/null
    echo 'Installed.'
    rm "$swiftly_package_path"
  fi
  echo 'Initializing…'
  ~/.swiftly/bin/swiftly init --assume-yes --skip-install 1>/dev/null
  source ~/.swiftly/env.sh
  echo 'Initialized.'
}

print_divider() {
  echo ''
}

enable_assertions() {
  source "$project_directory"/tooling/assert.sh
}

# dswtc stands for "Deus Swift toolchain" — the specific version of the Swift toolchain required by
# this project. For more information, run `./bin/dswtcinfo help`.
configure_dswtc() {
  echo '=== SWIFT TOOLCHAIN ==='
  echo 'Checking installation…'
  if dswtcinfo path &>/dev/null; then
    was_dswtc_previously_installed=true
    local swiftly_configuration_file_path=~/.swiftly/config.json
    echo 'Already installed. Skipping installation.'

    # Although dswtc is installed, in the event of Swiftly being uninstalled and installed again
    # while dswtc remained present, the reinstalled version, as of 1.1.1, does not recognize dswtc
    # as an installed toolchain. In these scenarios, we force Swiftly to consider dswtc as such by
    # editing its configuration file.
    if ! jq '.installedToolchains' "$swiftly_configuration_file_path" \
      | xargs                                                         \
      | tr -d '\n'                                                    \
      | grep --max-count 1 --quiet "$(dswtcinfo version)"; then
      echo 'Swiftly does not recognize it as an installed toolchain. Forcing recognition…'
      echo "$(jq                                   \
        --arg dswtc_version "$(dswtcinfo version)" \
        '.installedToolchains += [$dswtc_version]' \
        "$swiftly_configuration_file_path")"       \
        >"$swiftly_configuration_file_path"
      echo 'Forced recognition by Swiftly of dswtc.'
    fi
  else
    was_dswtc_previously_installed=false
    echo 'Not installed. Installing…'
    swiftly install --assume-yes "$(dswtcinfo version)" 1>/dev/null
    echo 'Installed.'
  fi
  swiftly link "$(dswtcinfo version)" --assume-yes 1>/dev/null
  swiftly use "$(dswtcinfo version)" 1>/dev/null
  assert_eq                           \
    "$(swiftly use --print-location)" \
    "$(dswtcinfo path)"               \
    'Swiftly is not using dswtc.'
  assert_eq                                                                     \
    "$(swift --version 2>/dev/null | head -n 1)"                                \
    'Apple Swift version 6.3-dev (LLVM 8322c7222063676, Swift d1735f66f43c37f)' \
    'Version of Swift is not 6.3-dev.'
  echo "Swiftly is using toolchain at $(dswtcinfo path)."
  if [ $sym_links_xcswtc_to_dswtc -eq 0 ]; then
    return
  fi
  local original_xcswtc_path=/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain
  if [ -L $original_xcswtc_path ]; then
    return
  elif [ ! -d $original_xcswtc_path ]; then
    echo "Could not sym-link the Xcode-bundled toolchain to that required by Deus because the \
Xcode-bundled toolchain was not found." >&2
  fi
  echo 'Creating symlink from Xcode-bundled toolchain…'

  # The symlink will live in the same directory as that of the original file; therefore, we rename
  # the original file. Appending a UUID may be a stretch, but ensures that the original file is
  # named uniquely.
  renamed_xcswtc_path="$original_xcswtc_path · Renamed by Deus · $(uuidgen)"
  sudo mv $original_xcswtc_path "$renamed_xcswtc_path"
  sudo ln -s "$(dswtcinfo path)" $original_xcswtc_path
  echo 'Sym-linked successfully.'
}

write_configuration_to_file() {
  local configuration_file_path="$project_directory"/.configuration.json
  cat >"$configuration_file_path" <<EOF
{
  "_warning": "This file was generated automatically upon configuration and should be neither \
modified nor deleted.",
EOF
  if [ -n ${renamed_xcswtc_path+1} ]; then
    cat >>"$configuration_file_path" <<EOF
  "renamedXcswtcPath": "$renamed_xcswtc_path",
EOF
  fi
  cat >>"$configuration_file_path" <<EOF
  "timestamp": $(date +"%s"),
  "wasDswtcPreviouslyInstalled": $was_dswtc_previously_installed,
  "wasSwiftlyPreviouslyInstalled": $was_swiftly_previously_installed
}
EOF
}

set -e
if [ "$option" = '-h' ] || [ "$option" = '--help' ]; then
  print_help
  return
fi
if [ "$option" != '--sym-link-xcswtc-to-dswtc' ]; then
  sym_links_xcswtc_to_dswtc=0
else
  sym_links_xcswtc_to_dswtc=1
fi
if [ -z "$option" ] || [ $sym_links_xcswtc_to_dswtc -eq 1 ]; then
  print_titled_overview
  print_divider
  prepare_binaries_for_execution
  enable_assertions
  configure_swiftly
  print_divider
  configure_dswtc
  write_configuration_to_file
  print_divider
  echo 'Done!'
else
  error
fi
